{% extends 'base.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'dashboard/css/product.css' %}">
{% endblock %}

{% block maincontent %}
<div class="product-container">
  <div class="product-gallery">
    <img src="{{ product.main_image.url }}" alt="{{ product.name }}" class="main-image">
    
    <div class="thumbnail-container">
      {% for image in images %}
        <img src="{{ image.image.url }}" alt="Thumbnail {{ image.id }}" class="thumbnail active">
      {% endfor %}
    </div>
  </div>
  
  <div class="product-details">
    <h1 class="product-title">{{ product.name }}</h1>
    
    <div class="rating">
      <span class="star">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
      <a href="#" class="ratings-count">Ratings 1</a>
    </div>
    
    <div class="brand-info">
      Brand: <a href="#" class="brand-link">{{ product.brand }}</a> | <a href="#" class="brand-link">More Products from this brand</a>
    </div>
    
    <div class="price-container">
      <span class="current-price">Rs.{{ product.price }}</span>
      <span class="original-price">Rs. 400</span>
      <span class="discount">-75%</span>
    </div>
    
    <div class="quantity-container">
      <span class="quantity-label">Quantity</span>
      <div class="quantity-controls">
        <button class="quantity-btn" id="decrease">‚àí</button>
        <input type="text" class="quantity-input" value="1" id="quantity">
        <button class="quantity-btn" id="increase">+</button>
      </div>
    </div>
    
    <div class="action-buttons">
      <button class="btn btn-buy">Buy Now</button>
      <button class="btn btn-cart" id="addToCart" data-id="{{ product.id }}" data-name="{{ product.name }}" data-price="{{ product.price }}" data-iamge="{{ product.image }}">Add to Cart</button>
    </div>
    
    <div class="delivery-section">
      <div class="section-title">
        <span>Delivery Options</span>
        <span class="info-icon">‚ìò</span>
      </div>
      
      <div class="address-container">
        <span>üìç</span>
        <div>
          <div>Bhadrapur, Jhapa</div>
          <div>1 - Bihibare Area, Sombare</div>
        </div>
        <a href="#" style="margin-left: auto; color: #0066c0;">CHANGE</a>
      </div>
      
      <div class="delivery-info">
        <span class="delivery-icon">üöö</span>
        <div>
          <div>Standard Delivery</div>
          <div style="color: #666; font-size: 12px;">Guaranteed within a week</div>
        </div>
        <div style="margin-left: auto;">
          <div>Rs. 135</div>
        </div>
      </div>
      
      <div class="delivery-info">
        <span class="delivery-icon">üí∞</span>
        <div>Cash on Delivery Available</div>
      </div>
    </div>
    <div style="display: flex;">
      <div class="return-section">
        <div class="section-title">
          <span>Return & Warranty</span>
          <span class="info-icon">‚ìò</span>
        </div>
        
        <div class="return-info">
          <span class="return-icon">üîÑ</span>
          <div>14 Days Free Returns</div>
        </div>
        
        <div class="return-info">
          <span class="return-icon">‚ö†Ô∏è</span>
          <div>Warranty not available</div>
        </div>
      </div>
      <div class="seller-info">
  <div class="section-title">
    <span>Seller Information</span>
    <span class="info-icon">‚ìò</span>
  </div>
  <div class="seller-details">
      <div><strong>Email:</strong> {{ product.seller.email }}</div>
      <div><strong>Phone:</strong> {{ product.seller.phone_no }}</div>
      <div>
        <a href="">
          View all products from this seller
        </a>
      </div>
    </div>
  </div>
    </div>
  </div>
</div>
<div class="product-description">
  {{ product.description }}
</div>

<div class="overlay" id="purchaseOverlay">
  <div class="overlay-content">
    <span class="close-btn" onclick="closeOverlay()">&times;</span>
    <h3>Order Product</h3>
    <form method="POST">
      {% csrf_token %}
      <div class="quantity-container">
        <label for="quantity" class="quantity-label">Quantity</label>
        <p class="quantity-btn" id="pdecrease" data-price="{{product.price}}">‚àí</p>
        <input type="text" class="quantity-input" value="1" id="pquantity" style="width: 30%;" readonly>
        <p class="quantity-btn" id="pincrease" data-price="{{product.price}}">+</p>
      </div>
      

      <label for="address">Shipping Address:</label>
      <input type="text" id="address" placeholder="Enter your address" required>

      <label for="payment">Payment Method:</label>
      <select id="payment">
        <option value="cod">Cash on Delivery</option>
        <option value="card">Credit/Debit Card</option>
        <option value="wallet">Digital Wallet</option>
      </select>

      <div>
        <div class="total-amount">
          <p style="padding: 5px;"><strong>Total Price: </strong></p>
          <p class="price">Rs.<span id="price">{{ product.price }}</span></p>
        </div>
        <div class="delivery-fee">
          <p style="padding: 5px;"><strong>Delivery Fee: </strong></p>
          <p class="price">Rs. 135</p>
        </div>
        <hr style="width:100%; border: none; border-top: 1px solid #eee; margin: 10px 0;">
        <div class="total-amount">
          <p style="padding: 5px;"><strong>Total Amount: </strong></p>
          <p class="price">Rs.<span id="totalAmount"></span></p>
        </div>
      </div>
      <button type="submit" class="btn">Confirm Order</button>
    </form>
  </div>
</div>

<script>
  function closeOverlay() {
      document.getElementById('purchaseOverlay').style.display = 'none';
  }

  function getCSRFToken() {
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
      return csrfToken ? csrfToken.value : '';
  };
  
  document.getElementById('pincrease').addEventListener('click', function() {
      const price = parseFloat(this.getAttribute('data-price'));
      let productCount = document.getElementById(`pquantity`);
      productCount.value = parseInt(productCount.value) + 1;

      let totalProductPrice = document.getElementById(`price`);
      totalProductPrice.innerHTML = `${(price * parseFloat(productCount.value)).toFixed(2)}`;
      productCount.value = parseInt(productCount.value);
  });

  document.getElementById('pdecrease').addEventListener('click', function() {
    const price = parseFloat(this.getAttribute('data-price'));
    let productCount = document.getElementById(`pquantity`);
    productCount.value = parseInt(productCount.value) - 1;

    if (productCount.value <= 0) {
        productCount.value = 1;
    }

    let totalProductPrice = document.getElementById(`price`);
    totalProductPrice.innerHTML = `${(price * parseFloat(productCount.value)).toFixed(2)}`;
});

  document.getElementById('totalAmount').innerHTML = (parseFloat(document.getElementById('price').innerHTML) + 135).toFixed(2);

  document.getElementById('addToCart').addEventListener('click',()=>{
      fetch(`${window.location.origin}/add_to_cart/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken':getCSRFToken()
                },
                body: JSON.stringify({
                    id: event.target.dataset.id,
                    name: event.target.dataset.name,
                    price: event.target.dataset.price,
                    image: event.target.dataset.image
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Item added to cart:', data);
                const successMessageContainer = document.createElement('div');
                const successMessage = document.createElement('div');
                successMessage.textContent = 'Item added to cart successfully!';
                successMessage.className = 'message-success';
                successMessageContainer.className = 'message-container';
                successMessageContainer.prepend(successMessage);
                document.body.prepend(successMessageContainer);

                setTimeout(() => {
                    successMessage.remove();
                }, 1500);
            })
            .catch(error => {
                console.error('Error adding item to cart:', error);
            });
    });

  // Handle quantity buttons
  document.getElementById('decrease').addEventListener('click', function() {
    const input = document.getElementById('quantity');
    const value = parseInt(input.value);
    if (value > 1) {
      input.value = value - 1;
    }
  });
  
  document.getElementById('increase').addEventListener('click', function() {
    const input = document.getElementById('quantity');
    const value = parseInt(input.value);
    input.value = value + 1;
  });
  
  // Simulate Buy Now functionality for now
  document.querySelector('.btn-buy').addEventListener('click', function() {
    document.getElementById('purchaseOverlay').style.display = 'block';
  });
</script>
{% endblock %}